<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, user-scalable=no, minimal-ui">

    <title>Smile</title>

    <style>
*, *:before, *:after {
  box-sizing: border-box;
}

html, body {height:100%;}
html {display:table; width:100%;}

.demo-content {
  background-color: #AAAAAA;
  margin: 0;
  text-align: center;
  display: table-cell; 
  vertical-align:middle;
}

    </style>
  </head>

  <body class="content">
    <input id="modelMnist" type="file"  accept=".onnx" onchange="uploadModelMnist(this)" >
    <br>
    <div class="container">
      <canvas style="touch-action: none;" id="canvasMnist" width="280" height="280"></canvas>
    </div>
    <br>
    <p id="infoMnist">...</p>

    <button id="gomnist" class="button is-large is-primary" disabled>submit</button>
    <button onclick="reset()">Reset</button>




    <script src="demos/htdocs/js/fabric.min.js"></script>
    <script src="demos/htdocs/js/jquery-3.4.0.min.js"></script>

    <script>
      var canvasMnist;
      var image;
      var bThick = 20;
      var cColour = '#FFFFFF'; // #black

      //Initialize  fabric
      function initcanvasMnist(){
        canvasMnist = new fabric.Canvas('canvasMnist');
        canvasMnist.isDrawingMode = true;
        canvasMnist.freeDrawingBrush.width = bThick;
        canvasMnist.freeDrawingBrush.color = cColour;
        canvasMnist.backgroundColor = '#000000';
      }

      window.onload = function(){
        initcanvasMnist();
        reset();
      };

      //reset canvasMnist
      function reset() {
        canvasMnist.clear();
        document.getElementById("infoMnist").innerHTML = "...";
      }


      document.getElementById('gomnist').addEventListener('click', () => {
        //context.drawImage(canvasMnistElem, -80, 0, 640  , 480);

        const dataURL = canvasMnist.toDataURL();
        $.ajax({
          type: 'POST',
          url: '/image',
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          data: JSON.stringify({image: dataURL, model: "mnist"}),
          success: function(data){
            console.log(data);
            $( ".infoMnist" ).html( data );
          },
          failure: function(errMsg) {
            alert(errMsg);
          }
        })
      });
      async function uploadModelMnist(e)
      {
        let name = { modelname:'mnist' };
        let formData = new FormData();
        let model = e.files[0];

        formData.append("model", model);
        formData.append("name", JSON.stringify(name));

        try {
          //let r = await fetch('/model', {method: "POST", body: formData});
          let r = await fetch('/model', {method: "POST", body: e.files[0]});
          document.getElementById("gomnist").disabled = false;

          console.log('HTTP response code:',r.status);
        } catch(e) {
          console.log('Huston we have problem...:', e);
        }

      }
    </script>
  </body>
</html>
